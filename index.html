<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Park Visit Certification</title>
    <style>
      #map {
        width: 100%;
        height: 100vh;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
    </style>
    <script
      type="text/javascript"
      src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0sq0mb7npe"
    ></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // 사용자 위치 데이터를 받아와서 웹뷰로부터 전달받는 함수
      window.addEventListener("message", (event) => {
        const userLocation = event.data; // { latitude: number, longitude: number }
        if (userLocation) {
          fetchParksData(userLocation);
        }
      });

      function fetchParksData(userLocation) {
        fetch("park_list.json")
          .then((response) => response.json())
          .then((parks) => initMap(userLocation, parks))
          .catch((error) => console.error("Error loading park data:", error));
      }

      function initMap(userLocation, parks) {
        const map = new naver.maps.Map("map", {
          center: new naver.maps.LatLng(
            userLocation.latitude,
            userLocation.longitude
          ),
          zoom: 16,
        });

        new naver.maps.Marker({
          position: new naver.maps.LatLng(
            userLocation.latitude,
            userLocation.longitude
          ),
          map: map,
          title: "Your Location",
        });

        parks.forEach((park) => {
          const parkLatLng = new naver.maps.LatLng(park._X, park._Y);
          const distance = getDistance(
            userLocation.latitude,
            userLocation.longitude,
            park._X,
            park._Y
          );

          // 근사치 반경 내에 있는 공원 찾기
          if (distance <= Math.sqrt(park.area) * 1.5) {
            new naver.maps.Marker({
              position: parkLatLng,
              map: map,
              title: park.name,
            });

            // 사용자가 공원 내에 있는지 확인
            if (distance <= Math.sqrt(park.area)) {
              alert(`인증완료: ${park.name}`);
            }
          }
        });
      }

      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // metres
        const φ1 = (lat1 * Math.PI) / 180;
        const φ2 = (lat2 * Math.PI) / 180;
        const Δφ = ((lat2 - lat1) * Math.PI) / 180;
        const Δλ = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
          Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // in metres
      }
    </script>
  </body>
</html>
